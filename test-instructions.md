# Testing the Tealium Model Context Protocol (MCP) Integration

This document provides instructions for testing the Tealium Model Context Protocol integration with the specified account and profile.

## Prerequisites

1. Your Tealium account details:
   - Account: `my-account`
   - Profile: `my-profile`
   - Data Source Key: `my-ds` (verified working key) or your custom data source key

2. Create a Data Source Key in Tealium if you want to use your own key:
   - Log in to [Tealium](https://my.tealiumiq.com)
   - Go to EventStream > Sources
   - Click "Add Source"
   - Select "HTTP API" as the source type
   - Name your source (e.g., "MCP Integration")
   - Save the source
   - Copy the Data Source Key from the created source
   - Make sure to publish your profile changes

3. The application running locally:
   ```
   npm run dev
   ```

## Tealium Trace IDs

Tealium generates trace IDs when you start a tracing session in the Tealium UI:

1. **How Trace IDs Work in Tealium**:
   - Trace IDs are generated by Tealium, not sent by your application
   - They allow you to identify specific events in the EventStream Trace tool
   - When you view the trace of an event, you'll see the trace ID Tealium assigned

2. **Using Tealium Trace**:
   - Log in to Tealium and go to EventStream > Trace
   - Click "Start Trace Session" 
   - Set a visitor ID filter if needed (to match the one in your tests)
   - Run your tests
   - Events will appear in real-time in the trace session

3. **Finding Specific Events**:
   - You can filter events in Tealium Trace by visitor ID, event name, or timestamp
   - For events sent through our API, the visitor ID is included in each request

## Option 1: Testing via UI

1. Start the local development server:
   ```bash
   npm run dev
   ```

2. Open your browser and navigate to http://localhost:3003/tealium-config

3. Fill out the form with the following information:
   - **Tealium Account**: Your Tealium account name
   - **Tealium Profile**: Your Tealium profile name
   - **Data Source Key**: Your Tealium HTTP API data source key
   - **Event Name**: Leave as `test_event` or customize
   - **User ID**: Optional identifier for testing

4. Click the "Send Test Event to Tealium" button

5. Check the debug information that appears after submitting, which will show:
   - Request payload sent
   - Response from Tealium
   - Any error messages if the request failed

## Option 2: Testing via API Script

1. Open the `test-tealium-api.js` file in your project.

2. Run the test script with your data source key:
   ```bash
   node test-tealium-api.js YOUR_ACTUAL_DATA_SOURCE_KEY
   ```

3. To test directly against the Tealium API (bypassing your server):
   ```bash
   node test-tealium-api.js YOUR_ACTUAL_DATA_SOURCE_KEY --direct
   ```

4. The script will run multiple tests with different payload formats to help diagnose any issues.

5. Check the console output for detailed logs of:
   - Request URLs and payloads
   - Response status codes
   - Response data
   - Success/failure messages

6. If you see success messages, the data source key is working correctly!

## Verifying the Data in Tealium

After running the tests, you can verify the data was received by Tealium:

1. Log in to your Tealium account at [https://my.tealiumiq.com](https://my.tealiumiq.com)
2. Navigate to the account and profile
3. Go to EventStream > Trace
4. Use one of these methods to find your event:
   - Filter by visitor ID: Enter the visitor ID used in your test
   - Filter by event name: Look for events with names like `test_event_simple`
   - Filter by timestamp: Look for events from when you ran the test
5. Click on an event to see its details and verify the data matches what you sent

You can also view recent events in the EventStream > Events section, which shows a historical log of all events received.

### Using Trace Mode in Tealium

For real-time debugging of your events:

1. In Tealium, go to EventStream > Trace
2. Click "Start Trace Session"
3. Configure your trace session:
   - Set the visitor ID to match the one in your test (if using a custom one)
   - Select your account and profile
   - Set any other filters you need
4. Run your test script or submit events through the UI
5. Watch for events to appear in real-time in the Trace session
6. Click on an event to see full details including:
   - All event attributes and values
   - Processing information
   - Event timeline
   - Source information

## Troubleshooting

If you encounter issues when testing:

1. **Data Source Key Error (400 Bad Request)**:
   - This is the most common issue. Verify that your Data Source Key is:
     - Created as an HTTP API data source in Tealium EventStream
     - Active and published
     - Copied correctly without any whitespace or extra characters
     - Formatted correctly (typically looks like a UUID)
   - Try both formats in the API:
     - Using the key in headers (`X-Tealium-Key`)
     - Using the key directly in the URL (`https://collect.tealiumiq.com/event/{dataSourceKey}`)

2. **API Errors**:
   - Check that your account and profile names are correct
   - Ensure that the data source is published in Tealium
   - Look at the response status code for information:
     - 400 = Bad Request (typically invalid key or malformed data)
     - 401 = Authentication issue
     - 403 = Permission issue
     - 404 = Endpoint not found (check URL format)
     - 429 = Rate limit exceeded

3. **"Body is unusable" Error**:
   - This is fixed in the latest API implementation
   - If you still see this, make sure you're running the latest version of the code

4. **Debug Mode**:
   - Use the debug mode to test the API without actually sending data to Tealium
   - In the API script: Set `useDebugMode = true` 
   - In direct API calls: Add `debug: true` to the request payload

5. **CORS Issues** (when testing in browser):
   - These usually happen when trying to make direct calls to Tealium
   - Use the server API route `/api/tealium` instead of making direct calls to Tealium

6. **Check the Network Tab and Server Logs**:
   - Open your browser's developer tools (F12) and check the Network tab
   - Check the server logs in your terminal to see more detailed error information
   - The logs will show both request and response details

## Manual Testing with cURL

You can test the API directly using cURL:

```bash
curl -X POST http://localhost:3003/api/tealium \
  -H "Content-Type: application/json" \
  -d '{
    "account": "my-account",
    "profile": "my-profile",
    "dataSourceKey": "YOUR_DATA_SOURCE_KEY",
    "debug": true,
    "payload": {
      "data": {
        "event_name": "test_event",
        "description": "Test event sent via cURL",
        "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'",
        "tealium_account": "my-account",
        "tealium_profile": "my-profile",
        "tealium_datasource": "YOUR_DATA_SOURCE_KEY",
        "source": "cURL Test",
        "tealium_visitor_id": "curl-test-visitor",
        "test_value": "This is a test from cURL"
      }
    }
  }'
```

To test directly against Tealium API (bypassing your server):

```bash
# Format 1: Using headers
curl -X POST https://collect.tealiumiq.com/event \
  -H "Content-Type: application/json" \
  -H "X-Tealium-Account: my-account" \
  -H "X-Tealium-Profile: my-profile" \
  -H "X-Tealium-Key: YOUR_DATA_SOURCE_KEY" \
  -d '{
    "event_name": "test_event",
    "description": "Direct API test via cURL",
    "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'",
    "source": "Direct cURL Test"
  }'

# Format 2: Using data source key in URL
curl -X POST https://collect.tealiumiq.com/event/YOUR_DATA_SOURCE_KEY \
  -H "Content-Type: application/json" \
  -d '{
    "event_name": "test_event",
    "description": "Direct API test via cURL with key in URL",
    "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'",
    "source": "Direct cURL Test"
  }'
```

To send data without debug mode, remove the `"debug": true,` line and replace `YOUR_DATA_SOURCE_KEY` with your actual key.

# Common Issues with Data Source Keys

The most common cause of 400 Bad Request errors with Tealium is related to the Data Source Key:

## What Exactly Is a Data Source Key?

A Data Source Key is a unique identifier that Tealium uses to authenticate and identify your HTTP API data source. It looks like a UUID (e.g., `b1c3d5e7-f9g8-h7j6-k5l4-m3n2p1q0r9s8`).

## Data Source Key Issues:

1. **Creating the Wrong Type of Data Source**:
   - You must create an **HTTP API** data source specifically
   - Other types of data sources won't work with this API

2. **Unpublished Profile**:
   - After creating a data source, you MUST publish your profile changes
   - In Tealium, click "Publish" in the top right corner after saving the source

3. **Copy/Paste Problems**:
   - The key is typically 36 characters long including dashes
   - Accidental whitespace at the beginning or end can break authentication
   - Make sure to copy the ENTIRE key without any extra characters

4. **Case Sensitivity**:
   - Data source keys may be case-sensitive
   - Copy exactly as displayed in Tealium

5. **Account Limits**:
   - You may have reached your API request limit
   - Check your Tealium account status and limits

## Verifying Your Data Source Key:

1. In Tealium, go to EventStream > Sources
2. Find your HTTP API source and check its status (it should say "Active")
3. Click on the source to view its details
4. Copy the key again, being very careful to get the exact value

If you're still having issues, try creating a new HTTP API data source in Tealium and use the new key.

# Working Configuration Summary

We have verified the following configuration works correctly with Tealium:

1. **Endpoint**: `https://collect.tealiumiq.com/event`

2. **Headers**:
   ```
   Content-Type: application/json
   X-Tealium-Account: my-account
   X-Tealium-Profile: my-profile
   X-Tealium-Key: my-ds
   ```

3. **Payload Structure**:
   The API supports two different payload structures:
   
   a) Direct structure (preferred):
   ```json
   {
     "event_name": "test_event",
     "description": "Test event",
     "tealium_account": "my-account",
     "tealium_profile": "my-profile",
     "source": "test",
     "tealium_visitor_id": "visitor-123456789"
   }
   ```
   
   b) Nested structure (handled by API route):
   ```json
   {
     "data": {
       "event_name": "test_event",
       "description": "Test event",
       "tealium_account": "my-account",
       "tealium_profile": "my-profile",
       "source": "test",
       "tealium_visitor_id": "visitor-123456789"
     }
   }
   ```

4. **Special Considerations**:
   - The Data Source Key is much shorter than typical Tealium keys, but must be valid to work
   - Tealium's response body is typically empty with a 200 status code on success
   - Empty response bodies are normal for this specific Tealium configuration
   - To track events in Tealium, use the EventStream > Trace tool and filter by visitor ID or event name

All tests have been successfully run against the real Tealium API. The integration is now working correctly. 
